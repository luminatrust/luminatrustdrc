<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Trust - Retrait</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --accent: #2ecc71; --bg: #f8faff; --danger: #ef4444; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); padding-bottom: 100px; }
        
        .header { background: var(--primary); color: white; padding: 30px 20px; border-radius: 0 0 30px 30px; text-align: center; }
        .balance-box { background: white; margin: -20px 20px 20px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; }
        .balance-val { font-size: 24px; font-weight: 600; color: var(--primary); }

        .form-card { background: white; margin: 20px; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
        input, select { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #eef2f7; background: #f1f5f9; font-family: inherit; box-sizing: border-box; outline: none; }
        
        .btn-send { width: 100%; padding: 18px; border: none; border-radius: 15px; background: var(--primary); color: white; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .btn-send:active { transform: scale(0.95); }

        .info-panel { background: #f0f7ff; color: #1e40af; padding: 15px; border-radius: 15px; font-size: 12px; margin-top: 20px; line-height: 1.6; border: 1px solid #dbeafe; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0;">Portefeuille Lumina</h2>
        <p style="font-size: 13px; opacity: 0.8;">Retrait de vos fonds</p>
    </div>

    <div class="balance-box">
        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 5px;">VOTRE SOLDE ACTUEL</div>
        <div class="balance-val" id="mySolde">0 FC</div>
    </div>

    <div class="form-card">
        <div class="input-group">
            <label>Montant Ã  retirer (Minimum 7.000 FC)</label>
            <input type="number" id="amount" placeholder="Ex: 10000" oninput="calculerFrais()">
            <div id="fraisMsg" style="font-size: 11px; color: var(--danger); margin-top: 5px; font-weight: 600;">Frais de maintenance (15%): 0 FC</div>
        </div>

        <div class="input-group">
            <label>RÃ©seau de paiement</label>
            <select id="method">
                <option value="M-Pesa">M-Pesa (Vodacom)</option>
                <option value="AirtelMoney">Airtel Money</option>
                <option value="OrangeMoney">Orange Money</option>
            </select>
        </div>

        <div class="input-group">
            <label>NumÃ©ro de tÃ©lÃ©phone (RDC)</label>
            <input type="tel" id="payPhone" placeholder="08XXXXXXXX" maxlength="10">
        </div>

        <button class="btn-send" onclick="validerRetrait()">Effectuer le retrait</button>
        
        <div class="info-panel">
            ðŸ’Ž <b>Conditions Lumina Trust :</b><br>
            â€¢ <b>Horaires :</b> 09h00 Ã  17h00 uniquement.<br>
            â€¢ <b>FrÃ©quence :</b> 1 seul retrait autorisÃ© par 24h.<br>
            â€¢ <b>Frais :</b> 15% appliquÃ©s sur le montant brut.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://firstsolar-e2ba3-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const userPhone = localStorage.getItem('userPhone');
        let currentBalance = 0;

        if(userPhone) {
            onValue(ref(db, 'users/' + userPhone), (snap) => {
                const d = snap.val();
                if(d) {
                    currentBalance = d.solde || 0;
                    document.getElementById('mySolde').innerText = currentBalance.toLocaleString() + " FC";
                }
            });
        }

        window.calculerFrais = () => {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const frais = amount * 0.15;
            const net = amount - frais;
            document.getElementById('fraisMsg').innerText = amount > 0 ? `Frais (15%): ${frais.toLocaleString()} FC | Net : ${net.toLocaleString()} FC` : "Frais de maintenance (15%): 0 FC";
        };

        window.validerRetrait = async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const method = document.getElementById('method').value;
            const payPhone = document.getElementById('payPhone').value;
            
            const now = new Date();
            if (now.getHours() < 9 || now.getHours() >= 17) return alert("ðŸ›‘ Retraits ouverts de 09h00 Ã  17h00.");
            if(!amount || amount < 7000) return alert("Montant min : 7.000 FC.");
            if(amount > currentBalance) return alert("Solde insuffisant.");
            if(payPhone.length < 10) return alert("NumÃ©ro invalide.");

            const frais = amount * 0.15;
            const montantNet = amount - frais;
            const dateStr = new Date().toISOString();

            if(confirm(`Confirmer le retrait de ${montantNet.toLocaleString()} FC net ?`)) {
                try {
                    // 1. DÃ©duire le solde
                    await update(ref(db, 'users/' + userPhone), { solde: currentBalance - amount });

                    // 2. Envoi vers l'Admin (pour traitement)
                    const reqData = {
                        user: userPhone,
                        montant_brut: amount,
                        montant_net: montantNet,
                        methode: method,
                        receveur: payPhone,
                        statut: "EN_ATTENTE",
                        date: dateStr
                    };
                    await push(ref(db, 'withdrawals'), reqData);

                    // 3. Envoi vers l'historique utilisateur (pour suivi)
                    await push(ref(db, 'users/' + userPhone + '/historique_retraits'), reqData);

                    alert("âœ… Demande envoyÃ©e !");
                    window.location.href = "dashboard.html";
                } catch (e) {
                    alert("Erreur serveur.");
                }
            }
        };
    </script>
</body>
</html>
